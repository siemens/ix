name: Deploy registry

on:
  push:
    branches:
      - main
      - 'release-registry/**'
      - 'feat/block-cli'
    paths:
      - 'packages/**'
      - 'blocks/**'
      - 'examples/**'
      - 'tooling/registry/**'
      - '.github/workflows/registry.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    concurrency: ci-registry-pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Checkout gh-pages
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        continue-on-error: true
        with:
          ref: gh-pages
          path: .gh-pages

      - uses: ./.github/workflows/actions/turbo

      - name: Determine deployment metadata
        id: deploy-meta
        run: |
          REF_NAME="${GITHUB_REF_NAME}"

          if [[ "${REF_NAME}" == "main" ]]; then
            VERSION="main"
          elif [[ "${REF_NAME}" == release-registry/* ]]; then
            VERSION="${REF_NAME#release-registry/}"
          else
            VERSION="${REF_NAME}"
          fi

          LATEST_TAG="${VERSION}"
          if [[ "${VERSION}" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            LATEST_TAG="${BASH_REMATCH[1]}"
          fi

          echo "registry_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "registry_path_prefix=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "registry_latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          if [[ "${VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "update_latest=true" >> "$GITHUB_OUTPUT"
          else
            echo "update_latest=false" >> "$GITHUB_OUTPUT"
          fi

          echo "Deploying registry version '${VERSION}'"

      - name: Debug deployment metadata
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_REF_NAME=${GITHUB_REF_NAME}"
          echo "registry_version=${{ steps.deploy-meta.outputs.registry_version }}"
          echo "registry_path_prefix=${{ steps.deploy-meta.outputs.registry_path_prefix }}"
          echo "registry_latest_tag=${{ steps.deploy-meta.outputs.registry_latest_tag }}"
          echo "update_latest=${{ steps.deploy-meta.outputs.update_latest }}"

      - name: Build
        env:
          REGISTRY_VERSION: ${{ steps.deploy-meta.outputs.registry_version }}
          REGISTRY_PATH_PREFIX: ${{ steps.deploy-meta.outputs.registry_path_prefix }}
          REGISTRY_LATEST_TAG: ${{ steps.deploy-meta.outputs.registry_latest_tag }}
        run: pnpm build --filter registry --cache-dir=.turbo

      - name: Debug dist artifacts
        run: |
          echo "== tooling/registry/dist top-level =="
          ls -la ./tooling/registry/dist || true
          echo "== key dist json files =="
          ls -la ./tooling/registry/dist/registry.json ./tooling/registry/dist/examples-registry.json ./tooling/registry/dist/components-registry.json || true
          echo "== first 40 files under dist =="
          find ./tooling/registry/dist -type f | sort | head -n 40 || true

      - name: Prepare merged deploy folder
        run: |
          rm -rf ./tooling/registry/deploy

          if [[ ! -d ./.gh-pages/.git ]]; then
            mkdir -p ./.gh-pages
          fi

          pnpm --filter registry exec tsx src/merge-pages-registry.ts \
            --dist-dir ./dist \
            --pages-dir ../../.gh-pages \
            --out-dir ./deploy \
            --version "${{ steps.deploy-meta.outputs.registry_version }}" \
            --latest-tag "${{ steps.deploy-meta.outputs.registry_latest_tag }}" \
            --update-latest "${{ steps.deploy-meta.outputs.update_latest }}"

      - name: Debug merged deploy folder
        run: |
          echo "== deploy top-level =="
          ls -la ./tooling/registry/deploy || true
          echo "== key deploy json files =="
          ls -la ./tooling/registry/deploy/registry.json ./tooling/registry/deploy/examples-registry.json ./tooling/registry/deploy/components-registry.json || true
          echo "== first 80 files under deploy =="
          find ./tooling/registry/deploy -type f | sort | head -n 80 || true

      - name: Deploy to GitHub Pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@d92aa235d04922e8f08b40ce78cc5442fcfbfa2f # v4.8.0
        with:
          folder: ./tooling/registry/deploy
          target-folder: .
          clean: true

      - name: Debug post-failure context
        if: failure()
        run: |
          echo "== gh-pages checkout =="
          ls -la ./.gh-pages || true
          echo "== deploy folder (on failure) =="
          ls -la ./tooling/registry/deploy || true
